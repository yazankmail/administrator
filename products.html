<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Wusooly Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        :root { --primary: #5c6bc0; --dark: #1e293b; --light: #f3f4f6; }
        body { font-family: 'Cairo', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 260px; background: var(--dark); color: #cbd5e1; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
        .logo { text-align: center; color: white; font-weight: 800; font-size: 22px; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .nav { list-style: none; padding: 0 10px; flex: 1; }
        .nav a { display: flex; align-items: center; gap: 10px; padding: 12px; color: #cbd5e1; text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; font-weight: 600; }
        .nav a:hover, .nav a.active { background: #334155; color: white; }
        .logout { padding: 20px; }
        .btn-out { width: 100%; padding: 10px; background: #ffebee; color: #d32f2f; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-add { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        
        .search-container { margin-bottom: 20px; position: relative; }
        .search-input { width: 100%; padding: 15px; padding-right: 45px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Cairo'; font-size: 16px; outline: none; }
        .search-icon { position: absolute; right: 15px; top: 15px; color: #777; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 15px; background: #f8fafc; color: #64748b; font-weight: bold; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .id-cell { font-family: monospace; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .active-badge { background: #dcfce7; color: #166534; }
        .out-badge { background: #fee2e2; color: #991b1b; }
        .size-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 2px; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 500px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 15px; position: relative; }
        .inp-group { margin-bottom: 15px; }
        .inp-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .inp-group input, .inp-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .sizes-wrapper { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px; }
        .size-option { display: flex; align-items: center; gap: 5px; background: #f9f9f9; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; }
        
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .close { position: absolute; left: 20px; top: 20px; cursor: pointer; font-size: 20px; color: #999; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spin { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spin"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

    <aside class="sidebar">
        <div class="logo">Wusooly Admin</div>
        <div class="nav">
            <a href="index.html">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="products.html" class="active">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
            <a href="#" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹')">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
        </div>
        <div class="logout"><button class="btn-out" onclick="window.logout()">Ø®Ø±ÙˆØ¬</button></div>
    </aside>

    <main class="main" id="content">
        <div class="header">
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
            <button class="btn-add" onclick="openModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        </div>

        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø¹Ø±Ù (ID)...">
        </div>

        <div class="table-box">
            <table>
                <thead><tr><th>ID</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </main>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">âœ•</span>
            <h2 id="modal-title" style="margin-top:0;">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            <input type="hidden" id="pid">
            
            <div class="inp-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="pname"></div>
            
            <div style="display:flex; gap:10px;">
                <div class="inp-group" style="flex:1"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label><input type="number" id="pprice"></div>
                <div class="inp-group" style="flex:1"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="pstock"></div>
            </div>

            <div class="inp-group">
                <label>Ø§Ù„ÙØ¦Ø© (ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ØªØ¬Ø±)</label>
                <select id="pcat">
                    <option value="ØªÙŠØ´ÙŠØ±Øª">ØªÙŠØ´ÙŠØ±Øª ğŸ‘•</option>
                    <option value="Ø¨ÙƒØ¬Ø§Øª Ù‡Ø¯Ø§ÙŠØ§">Ø¨ÙƒØ¬Ø§Øª Ù‡Ø¯Ø§ÙŠØ§ ğŸ</option>
                    <option value="Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª">Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª ğŸ’</option>
                    <option value="Ø´Ù†Ø·">Ø´Ù†Ø· ğŸ‘œ</option>
                    <option value="Ø£Ø­Ø°ÙŠØ©">Ø£Ø­Ø°ÙŠØ© ğŸ‘Ÿ</option>
                    <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª ğŸ“±</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>

            <div class="inp-group">
                <label>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© (Ù„Ù„ØªÙŠØ´ÙŠØ±ØªØ§Øª ÙˆØ§Ù„Ø£Ø­Ø°ÙŠØ©)</label>
                <div class="sizes-wrapper">
                    <label class="size-option"><input type="checkbox" name="size" value="S"> S</label>
                    <label class="size-option"><input type="checkbox" name="size" value="M"> M</label>
                    <label class="size-option"><input type="checkbox" name="size" value="L"> L</label>
                    <label class="size-option"><input type="checkbox" name="size" value="XL"> XL</label>
                    <label class="size-option"><input type="checkbox" name="size" value="XXL"> XXL</label>
                    <label class="size-option"><input type="checkbox" name="size" value="36"> 36</label>
                    <label class="size-option"><input type="checkbox" name="size" value="37"> 37</label>
                    <label class="size-option"><input type="checkbox" name="size" value="38"> 38</label>
                    <label class="size-option"><input type="checkbox" name="size" value="39"> 39</label>
                    <label class="size-option"><input type="checkbox" name="size" value="40"> 40</label>
                    <label class="size-option"><input type="checkbox" name="size" value="41"> 41</label>
                    <label class="size-option"><input type="checkbox" name="size" value="42"> 42</label>
                    <label class="size-option"><input type="checkbox" name="size" value="43"> 43</label>
                    <label class="size-option"><input type="checkbox" name="size" value="44"> 44</label>
                    <label class="size-option"><input type="checkbox" name="size" value="45"> 45</label>
                </div>
            </div>

            <div class="inp-group">
                <label>ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬ (Ø­ØªÙ‰ 4 ØµÙˆØ±)</label>
                <input type="text" id="img1" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" style="margin-bottom:5px;">
                <input type="text" id="img2" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 2" style="margin-bottom:5px;">
                <input type="text" id="img3" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 3" style="margin-bottom:5px;">
                <input type="text" id="img4" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© 4">
            </div>

            <button class="btn-save" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBa0RwEcbVqWYAKeUFeZy2IDihaxUxtNKY", authDomain: "wusooly-1906b.firebaseapp.com", projectId: "wusooly-1906b", storageBucket: "wusooly-1906b.firebasestorage.app", messagingSenderId: "95836343161", appId: "1:95836343161:web:73ae3faaca406c0bf7fda8" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN = "hmamda320@gmail.com";
        let allProducts = [];

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN) {
                document.getElementById('content').style.display = 'block';
                loadProducts();
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadProducts() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
            try {
                const snapshot = await getDocs(collection(db, "products"));
                allProducts = [];
                snapshot.forEach(d => {
                    const data = d.data(); data.id = d.id;
                    allProducts.push(data);
                });
                renderTable(allProducts);
                document.getElementById('loader').style.display = 'none';
            } catch (error) { alert("Ø®Ø·Ø£: " + error.message); document.getElementById('loader').style.display = 'none'; }
        }

        function renderTable(products) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            if (products.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>'; return; }

            products.forEach(data => {
                const stock = Number(data.stock);
                const badge = stock > 0 ? `<span class="badge active-badge">Ù†Ø´Ø·</span>` : `<span class="badge out-badge">Ù†ÙØ°Øª</span>`;
                
                let sizesHtml = '-';
                if (data.sizes && data.sizes.length > 0) {
                    sizesHtml = data.sizes.map(s => `<span class="size-tag">${s}</span>`).join(' ');
                }

                const mainImg = (data.images && data.images.length > 0) ? data.images[0] : 'https://via.placeholder.com/40';

                tbody.innerHTML += `
                    <tr>
                        <td><span class="id-cell">#${data.id.substring(0, 5)}</span></td>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${mainImg}" style="width:40px; height:40px; border-radius:5px; object-fit:cover;">
                                <span>${data.name}</span>
                            </div>
                        </td>
                        <td>${data.category}</td>
                        <td>${data.price} â‚ª</td>
                        <td>${sizesHtml}</td>
                        <td>${badge} (${stock})</td>
                        <td>
                            <button onclick="window.editItem('${data.id}')" style="border:none; background:none; cursor:pointer;">âœï¸</button>
                            <button onclick="window.deleteItem('${data.id}')" style="border:none; background:none; cursor:pointer; color:red;">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            renderTable(allProducts.filter(p => p.id.toLowerCase().includes(val)));
        });

        window.openModal = () => { 
            document.getElementById('modal').style.display = 'flex'; 
            document.getElementById('modal-title').innerText = 'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('pid').value = '';
            
            document.getElementById('pname').value = '';
            document.getElementById('pprice').value = '';
            document.getElementById('pstock').value = '';
            document.getElementById('img1').value = '';
            document.getElementById('img2').value = '';
            document.getElementById('img3').value = '';
            document.getElementById('img4').value = '';
            
            document.querySelectorAll('input[name="size"]').forEach(cb => cb.checked = false);
        };
        window.closeModal = () => document.getElementById('modal').style.display = 'none';

        window.saveData = async () => {
            const id = document.getElementById('pid').value;
            
            const selectedSizes = [];
            document.querySelectorAll('input[name="size"]:checked').forEach(cb => selectedSizes.push(cb.value));

            const images = [];
            if(document.getElementById('img1').value) images.push(document.getElementById('img1').value);
            if(document.getElementById('img2').value) images.push(document.getElementById('img2').value);
            if(document.getElementById('img3').value) images.push(document.getElementById('img3').value);
            if(document.getElementById('img4').value) images.push(document.getElementById('img4').value);

            const data = {
                name: document.getElementById('pname').value,
                price: Number(document.getElementById('pprice').value),
                stock: Number(document.getElementById('pstock').value),
                category: document.getElementById('pcat').value,
                sizes: selectedSizes,
                images: images,
                updatedAt: Date.now()
            };

            const btn = document.querySelector('.btn-save'); btn.innerText = "...";
            try {
                if (id) await updateDoc(doc(db, "products", id), data);
                else { data.createdAt = Date.now(); await addDoc(collection(db, "products"), data); }
                closeModal(); loadProducts(); btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
            } catch (e) { alert(e.message); btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬"; }
        };

        window.editItem = (id) => {
            const item = allProducts.find(x => x.id === id);
            if (item) {
                openModal(); document.getElementById('modal-title').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
                document.getElementById('pid').value = id;
                document.getElementById('pname').value = item.name;
                document.getElementById('pprice').value = item.price;
                document.getElementById('pstock').value = item.stock;
                document.getElementById('pcat').value = item.category;
                
                if(item.images) {
                    document.getElementById('img1').value = item.images[0] || '';
                    document.getElementById('img2').value = item.images[1] || '';
                    document.getElementById('img3').value = item.images[2] || '';
                    document.getElementById('img4').value = item.images[3] || '';
                }

                if (item.sizes) {
                    document.querySelectorAll('input[name="size"]').forEach(cb => {
                        cb.checked = item.sizes.includes(cb.value);
                    });
                }
            }
        };

        window.deleteItem = async (id) => { if (confirm("Ø­Ø°ÙØŸ")) { await deleteDoc(doc(db, "products", id)); loadProducts(); } };
        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>
